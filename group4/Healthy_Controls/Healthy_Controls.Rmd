---
title: "Healthy Control Samples"
author: "Anna Korda"
date: "2025-05-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## A 16S study with Healthy Donor Samples

This study (<https://www.ebi.ac.uk/ena/browser/view/PRJEB41316>) profiles the gut microbiome of carefully screened stool donors from a universal stool bank, using 16S rRNA sequencing on 200 samples from 86 donors. With **detailed lifestyle metadata and strict donor selection**, it offers a rare and **valuable reference for defining healthy gut microbiome baselines**. We used their official pipeline from OpenBiome's Github <https://github.com/openbiome/donors-16s/tree/v1.1>, running the full Snakemake workflow and performing additional analysis to identify the most central, representative healthy control samples.

\*This study was not available in MGnify

```{r libraries, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(vegan)
library(compositions)  
library(robustbase)   
library(gridExtra)
```

## File inputs

The input files used in this analysis were generated by running the Snakemake pipeline provided by the authors of the dataset via GitHub. Specifically, we used otu_table.tsv (containing OTU abundance counts) and the beta-diversity results (beta.tsv) exported by the pipeline. Additional files such as metadata.csv (sample and sequencing metadata) and donor_health_data.xlsx (lifestyle and health information of each donor) were already included in the dataset release and required no preprocessing.

```{r load_metadata, include=FALSE, message=FALSE, warning=FALSE}
# Load metadata and health data
metadata <- read_csv("metadata.csv")
health <- read_excel("data-descriptions/donor_health_data.xlsx")

# Merge and filter metadata
metadata_health <- metadata %>%
  left_join(health, by = c("donor" = "Publication Donor Code")) %>%
  mutate(
    `Donor BMI` = as.numeric(`Donor BMI`),
    alcohol_int = str_extract(`Donor's average weekly alcohol usage (if known)`, "\\d+") %>% as.integer()
  )
```

## Filtering Steps

In the previous chunk, we combined the main metadata with the donor health descriptions to enable an initial round of filtering before identifying the most central (i.e., representative) samples. Specifically, we retained only those samples from donors with a healthy BMI, no reported medications or allergies, and low or no alcohol intake. These pre-filtered samples were then subjected to further statistical analysis.

```{r step3_filter, message=FALSE, warning=FALSE, echo=TRUE}

# Load beta.tsv to extract used sample IDs
beta_tibble <- read_tsv("beta.tsv")
sample_ids <- beta_tibble[[1]]  # first column (sample names used)

# Subset metadata to only those samples the authors used
metadata_matched <- metadata_health %>%
  filter(sample_id %in% sample_ids)

# Apply YOUR filters exactly
step3 <- metadata_matched %>%
  filter(
    between(`Donor BMI`, 18.5, 25),
    trimws(`List of medications taken by donor (If any)`) == "N/A",
    trimws(`Donor's known allergies (if any)`) == "N/A",
    is.na(`Donor's average weekly alcohol usage (if known)`) | alcohol_int <= 2
  )

# Load OTU table and subset to filtered samples
otu <- read_tsv("otu_table.tsv", skip = 1) %>%
  rename(otu_id = `#OTU ID`) %>%
  column_to_rownames("otu_id")

otu_filtered <- otu[, step3$sample_id]
```

## Identifying Central Healthy Profiles Using Multivariate Statistics

To define the most representative healthy controls, we **normalized the OTU table using a Centered Log-Ratio (CLR) transformation**, which is appropriate for compositional microbiome data. We then applied **Principal Component Analysis (PCA) to reduce dimensionality**, ensuring compatibility with **Mahalanobis distance estimation**. This distance **quantifies how far each sample lies from the center of the distribution in multivariate space**. Our approach is conceptually similar to the **CLOUD test** introduced by **Lloyd-Price et al. (2018)** (<https://doi.org/10.1186/s40168-018-0514-4>), which identifies microbial community deviations by evaluating distances from a healthy reference cloud. We used this idea to rank healthy samples and select those closest to the **"core" healthy microbiome profile.**

```{r mahalanobis_analysis, message=FALSE, warning=FALSE}

# CLR transform
otu_clr <- clr(otu_filtered + 1)

# Transpose to get samples as rows
otu_clr_t <- t(otu_clr)

# Remove constant columns (zero variance)
otu_clr_t_nz <- otu_clr_t[, apply(otu_clr_t, 2, var) != 0]

# PCA
otu_pca <- prcomp(otu_clr_t_nz, center = TRUE, scale. = TRUE)
pca_coords <- otu_pca$x[, 1:10]

# Mahalanobis with fixed seed
set.seed(42) #reproducibility
mahal <- covMcd(pca_coords)
distances <- mahalanobis(pca_coords, center = mahal$center, cov = mahal$cov)

# Match to samples and merge
sample_ids <- rownames(pca_coords)
distances_df <- tibble(sample_id = sample_ids, mahalanobis = distances)

step3_ranked <- step3 %>%
  inner_join(distances_df, by = "sample_id") %>%
  arrange(mahalanobis)

```

## Output

We selected the top 5 most central healthy control samples, based on Mahalanobis distance, to serve as a reference baseline for our own pipeline.

```{r top5, echo=FALSE, message=FALSE, warning=FALSE}

# Output
top5 <- step3_ranked %>%
  select(
    sample_id,
    donor,
    `Donor BMI`,
    alcohol_int,
    mahalanobis
  ) %>%
  head(5)

write_csv(top5, "top5_healthy_samples.csv")
print(top5)

```

The top 5 most central healthy control samples, as measured by Mahalanobis distance in CLR-transformed PCoA space, are shown above. Lower Mahalanobis values indicate samples that are closer to the healthy population center. These samples span 4 unique donors.

## PCA plots of Final Baseline Samples vs. Unfiltered & Filtered

We generate these PCA plots to visually compare the variation in the healthy control samples before and after filtering, allowing us to see where our top 5 samples fall, as we expect them to be the most central.

```{r pca, echo=FALSE, message=FALSE, warning=FALSE}

#  Use matched OTU table (197 samples) for the before filtering PCA plot
otu_unfiltered <- otu

# Apply CLR + PCA on unfiltered OTU (the same we did before with the filtered)
otu_unfiltered_clr <- clr(otu_unfiltered + 1)
otu_unfiltered_clr_t <- t(otu_unfiltered_clr)
otu_unfiltered_clr_t_nz <- otu_unfiltered_clr_t[, apply(otu_unfiltered_clr_t, 2, var) != 0]

otu_unfiltered_pca <- prcomp(otu_unfiltered_clr_t_nz, center = TRUE, scale. = TRUE)
pca_unfiltered_coords <- otu_unfiltered_pca$x[, 1:2]

# Filtered PCA already computed as pca_coords from before
pca_df <- as.data.frame(pca_coords)
pca_df$sample_id <- rownames(pca_df)

# Join top5 with filtered PCA coords
top5_pca <- inner_join(top5, pca_df, by = "sample_id")

# Unfiltered PCA coords
pca_unf_df <- as.data.frame(pca_unfiltered_coords)
pca_unf_df$sample_id <- rownames(pca_unf_df)

# Join top5 with unfiltered PCA coords
top5_unf <- inner_join(top5, pca_unf_df, by = "sample_id")

# Set shared axis limits for comparable results 
pc1_lim <- range(c(pca_df$PC1, pca_unf_df$PC1))
pc2_lim <- range(c(pca_df$PC2, pca_unf_df$PC2))

# Plot filtered PCA, I am applying dark blue instead of grey for the non-highlighted points because gray is not distinguishable
pca_filtered <- ggplot(pca_df, aes(x = PC1, y = PC2)) +
  geom_point(size = 3, color = "darkblue") +
  geom_point(data = top5_pca, aes(x = PC1, y = PC2), color = "red", size = 4) +
  theme_minimal() +
  labs(title = "") +
  theme(
    legend.position = "none", 
    axis.title = element_text(size = 14), 
    axis.text = element_text(size = 12), 
    axis.text.x = element_text(angle = 45, hjust = 1),  
    axis.text.y = element_text(angle = 0, hjust = 1),  
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_blank(),
    plot.margin = margin(10, 10, 10, 10)
  ) +
  scale_x_continuous(limits = pc1_lim) +
  scale_y_continuous(limits = pc2_lim)

# Plot unfiltered PCA 
pca_unfiltered <- ggplot(pca_unf_df, aes(x = PC1, y = PC2)) +
  geom_point(size = 3, color = "darkblue") +
  geom_point(data = top5_unf, aes(x = PC1, y = PC2), color = "red", size = 4) +
  theme_minimal() +
  labs(title = "") +
  theme(
    legend.position = "none", 
    axis.title = element_text(size = 14), 
    axis.text = element_text(size = 12), 
    axis.text.x = element_text(angle = 45, hjust = 1),  
    axis.text.y = element_text(angle = 0, hjust = 1),  
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_blank(),
    plot.margin = margin(10, 10, 10, 10)
  ) +
  scale_x_continuous(limits = pc1_lim) +
  scale_y_continuous(limits = pc2_lim)

# Combine plots in one grid
grid.arrange(
  pca_unfiltered,
  pca_filtered,
  ncol = 2,
  top = "PCA Comparison: Top 5 Healthy Controls vs. All Samples Before(=197) and After(=51) Filtering"
)

```

**Interpretation**

**Left plot**: In this plot that shows all healthy samples before filtering, the samples are scattered, showing more variation. The red points highlight the Top 5 Healthy Controls, which are central to the data, representing the least variation and most typical healthy profiles.

Note: Some points may appear fewer due to overlap , samples with similar PC1/PC2 values are plotted on top of each other.

This is especially common in tightly clustered, filtered data.

**Right plot**: Top 5 Healthy Controls Highlighted (Filtered Data) After applying filtering based on BMI, medications, allergies, and alcohol intake, the remaining 51 samples are plotted. The red points still represent the Top 5 Healthy Controls, which remain central in the filtered dataset, showing minimal variation.

Center and Centrality **In PCA, the "center" is the mean of all samples in the reduced space (PC1, PC2). The central samples, closest to this mean, are the most typical healthy controls.** These samples serve as a baseline for comparing deviations or disruptions in the microbiome of other individuals.

In summary, the **Top 5 Healthy Controls possibly represent stable and typical healthy profiles, providing a reliable baseline for comparison in microbiome studies.**

```{r get_codes, echo=FALSE, message=FALSE, warning=FALSE}

# Load file list
file_list_filtered <- read_csv("file_list.csv") 

# Filter to top5 sample IDs
top5_runs <- file_list_filtered %>%
  filter(sample_id %in% top5$sample_id)


output_data <- top5_runs %>%
  mutate(run_accession = gsub("ftp.sra.ebi.ac.uk/vol1/run/([A-Za-z0-9]+)/(ERR[0-9]+).*", "\\2", ftp)) %>%
  mutate(project_link = "https://www.ebi.ac.uk/ena/browser/view/PRJEB41316") %>%
  select(sample_id, run_accession, project_link) %>%
  distinct()  # this removes duplicate rows


write.csv(output_data, "healthy_samples_run_accessions.csv", row.names = FALSE)

# Display result
print(output_data)


```

To retrieve the samples from the output:

The run_accession column contains run ID (e.g., ERR4836388, ERR4836483).

The project_link column provides a direct link to the project's page on the European Nucleotide Archive (ENA).

Download the data by going to the main project page and select the samples of your interest via run_accession. Or use any of the files provided along with this .Rmd if they are of any use to you.

## Conclusion

To identify representative healthy baseline samples for downstream pipeline development, we conducted a focused selection process using a high-quality 16S fecal microbiome donor study (PRJEB41316), which includes both raw sequencing data and detailed donor metadata. Our goal was to extract 1–3 samples that are biologically healthy, free of confounding factors, and representative of the central structure of the healthy population.

We began by filtering the metadata using strict but interpretable health criteria. Specifically, we retained only those samples with:

-   A body mass index (BMI) within the healthy range (18.5–25),

-   No reported medications,

-   No known allergies, and

-   Low or no alcohol consumption (≤1–2 units per week).

This reduced the dataset to 51 high-quality, biologically clean samples suitable for defining a healthy baseline.

To identify the most representative samples among these, we applied a centered log-ratio (CLR) transformation to the OTU table, followed by principal component analysis (PCA) to reduce dimensionality while preserving variation. We then used the Mahalanobis distance on the PCA-reduced space to quantify how centrally each sample lies relative to the overall distribution. Samples with the lowest Mahalanobis distance were considered the most representative (central, not outliers), making them ideal reference points for comparison in future analyses.

Our final top 3–5 samples span multiple donors but exhibit consistent microbial profiles, positioning them as good candidates for a universal healthy baseline in microbiome analysis pipelines.

```{r session, echo=FALSE}
sessionInfo()
```
